- name: Count the number of VMs before
  virt:
    command: list_vms
    state: running
  register: start_cirros_vm_count_before

- name: Start a cirros instance
  shell: |
    sf-client --no-pretty instance create inst-{{inventory_hostname}} 1 1 -d 8@cirros -n "{{network_uuid}}"

- name: Count the number of VMs after
  virt:
    command: list_vms
    state: running
  register: start_cirros_vm_count_after

- name: Make sure we have one more VM
  fail:
    msg: We failed to start a VM on {{inventory_hostname}}.
  when: start_cirros_vm_count_before == start_cirros_vm_count_after

- name: Determine instance uuid
  shell: |
    sf-client --no-pretty instance list | grep {{inventory_hostname}} | cut -f 1 -d ","
  register: centos_instance_uuid_complex

- name: Extract instance uuid
  set_fact:
    centos_instance_uuid: "{{centos_instance_uuid_complex.stdout}}"

- name: Log instance uuid
  debug:
    msg: Instance uuid is {{centos_instance_uuid}}.

- name: Determine instance console port
  shell: |
    sf-client --no-pretty instance show {{centos_instance_uuid}} | grep "console port" | cut -f 2 -d ":"
  register: centos_console_port_complex

- name: Extract console port
  set_fact:
    centos_console_port: "{{centos_console_port_complex.stdout}}"

- name: Log instance console port
  debug:
    msg: Instance console port is {{centos_console_port}}.

- name: Determine instance IP
  shell: |
    sf-client --no-pretty instance show {{centos_instance_uuid}} | grep "ipv4" | cut -f 2 -d ":"
  register: centos_instance_ip_complex

- name: Extract instance IP
  set_fact:
    centos_instance_ip: "{{centos_instance_ip_complex.stdout}}"

- name: Log instance IP
  debug:
    msg: Instance IP is {{centos_instance_ip}}.

# This needs to be so long because DHCP failures take a fair while to happen
- name: Wait for instances to boot
  pause:
    minutes: 2

- name: udhcp should have started
  shell: |
    [ `grep -c "udhcpc: started" /srv/shakenfist/instances/{{centos_instance_uuid}}/console.log` -eq 1 ]

- name: udhcp should have acquired a lease
  shell: |
    [ `grep -c "udhcpc: no lease, failing" /srv/shakenfist/instances/{{centos_instance_uuid}}/console.log` -eq 0 ]
