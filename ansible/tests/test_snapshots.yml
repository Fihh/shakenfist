#########################################
# Import inventory from terraform
#########################################

- hosts: localhost
  gather_facts: yes
  connection: ssh
  vars_files:
    - ../vars

  tasks:
    - include: ../terraform/{{cloud}}/terraform.yml

#########################################
# Scenario: we can start cirros VMs
#########################################

- hosts: hypervisors
  any_errors_fatal: true
  become: yes
  become_method: sudo
  gather_facts: no
  connection: ssh
  vars_files:
    - ../vars

  tasks:
    - include: _setup.yml
    - include: _util_instance_start.yml
        name="cirros"
        distro=cirros
        network="{{net_one_uuid}}"
        sshkey=""
        userdata=""

    - name: Validate
      copy:
        content: |
          #!/bin/bash -e

          [ `sf-client --simple instance list | grep sf-1 | wc -l` -eq 1 ]
          [ `sf-client --simple instance list | grep sf-2 | wc -l` -eq 1 ]
        dest: /tmp/shell_script
        owner: root
        group: root
        mode: u=rx,g=rx,o=rx

    - name: Execute
      shell: /tmp/shell_script

#########################################
# Scenario: snapshots work
#########################################

- hosts: sf-1
  any_errors_fatal: true
  become: yes
  become_method: sudo
  gather_facts: no
  connection: ssh
  vars_files:
    - ../vars

  tasks:
    - name: Snapshot sf-1 cirros
      shell: |
        sf-client instance snapshot {{hostvars['sf-1']['cirros_uuid']}}

    - name: Validate
      shell: |
        [ `sf-client --simple instance show {{hostvars['sf-1']['cirros_uuid']}} True | grep -v "snapshot,uuid" | grep -c "snapshot,"` -eq 1 ]

    - name: Snapshot sf-2
      shell: |
        sf-client instance snapshot {{hostvars['sf-2']['cirros_uuid']}} True

    - name: Validate
      shell: |
        [ `sf-client --simple instance show {{hostvars['sf-2']['cirros_uuid']}} True | grep -v "snapshot,uuid" | grep -c "snapshot,"` -eq 2 ]

#########################################
# Scenario: we do not snapshot CD-ROMs
#########################################

- hosts: sf-1
  any_errors_fatal: true
  become: yes
  become_method: sudo
  gather_facts: no
  connection: ssh
  vars_files:
    - ../vars

  tasks:
    - name: Start a cirros instance on sf-1
      sf_instance:
        name: "cirros_cdrom"
        cpu: 1
        ram: 1
        disks:
          - "8@cirros"
          - "8@http://archive.ubuntu.com/ubuntu/dists/focal/main/installer-amd64/current/legacy-images/netboot/mini.iso"
        networks:
          - "{{net_one_uuid}}"
        ssh_key: ""
        user_data: ""
        placement: "{{inventory_hostname}}"
      register: instance_create_out

    - name: Log instance details
      debug:
        msg: "{{instance_create_out}}"

    - name: Extract instance uuid
      set_fact:
        "cirros_cdrom_uuid": "{{instance_create_out.meta.uuid}}"

    - name: Snapshot instance
      shell: |
        sf-client instance snapshot {{cirros_cdrom_uuid}} True

    - name: Validate
      shell: |
        [ `sf-client --simple instance show {{cirros_cdrom_uuid}} True | grep -v "snapshot,uuid" | grep -c "snapshot,"` -eq 1 ]

    - name: Delete instance
      shell: |
        sf-client instance delete {{cirros_cdrom_uuid}}
